{% extends 'base.html' %}
{% block title %}Jogo da Mem√≥ria - EmotionAI{% endblock %}
{% block content %}
<div class="container pb-5">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div><h1 class="page-heading"><i class="bi bi-grid-3x3-gap"></i> Jogo da Mem√≥ria</h1>
            <p class="text-muted">Encontre os pares de emo√ß√µes. Foque no momento presente.</p></div>
            <a href="{% url 'games_menu' %}" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> Voltar</a>
        </div>
    </div>
    <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div><span class="badge bg-primary fs-6" id="scoreDisplay">Pontos: 0</span>
            <span class="badge bg-secondary fs-6 ms-2" id="movesDisplay">Movimentos: 0</span></div>
            <div><span class="badge bg-info fs-6" id="timerDisplay">‚è±Ô∏è 0:00</span></div>
            <button class="btn btn-sm btn-success" id="newGameBtn"><i class="bi bi-arrow-clockwise"></i> Novo Jogo</button>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div id="gameBoard" class="d-flex flex-wrap justify-content-center gap-2"></div>
        </div>
    </div>
    <div id="gameComplete" class="card p-4 mt-4 text-center d-none" style="background:linear-gradient(135deg,rgba(76,175,80,.15),rgba(33,150,243,.15));border:2px solid rgba(76,175,80,.4);">
        <h3>üéâ Parab√©ns!</h3>
        <p class="fs-5">Voc√™ completou o jogo!</p>
        <div class="d-flex justify-content-center gap-3 mb-3">
            <span class="badge bg-primary fs-6 p-2" id="finalScore">0 pts</span>
            <span class="badge bg-info fs-6 p-2" id="finalTime">0:00</span>
            <span class="badge bg-secondary fs-6 p-2" id="finalMoves">0 moves</span>
        </div>
        <div class="d-flex justify-content-center gap-2">
            <button class="btn btn-success" onclick="startNewGame()"><i class="bi bi-arrow-clockwise"></i> Jogar Novamente</button>
            <a href="{% url 'games_menu' %}" class="btn btn-outline-light">Menu de Jogos</a>
        </div>
    </div>
</div>
<style>
.memory-card{width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;transition:all .3s ease;background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;user-select:none;border:2px solid transparent;}
.memory-card:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(0,0,0,.3);}
.memory-card.flipped{background:rgba(255,255,255,.15);border-color:var(--primary);transform:rotateY(180deg);}
.memory-card.matched{background:rgba(76,175,80,.3);border-color:#4CAF50;cursor:default;animation:matchPulse .5s ease;}
@keyframes matchPulse{0%,100%{transform:scale(1);}50%{transform:scale(1.1);}}
@media(min-width:768px){.memory-card{width:100px;height:100px;font-size:2.5rem;}}
</style>
<script>
const emojis=['üòä','üò¢','üò°','üò®','üò≤','ü§¢','üòå','ü•∞','üò§','ü§ó','üò∞','üé≠'];
let cards=[],flippedCards=[],matchedPairs=0,moves=0,score=0,gameTimer,seconds=0,gameActive=false;

function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

function startNewGame(){
    const board=document.getElementById('gameBoard');
    board.innerHTML='';
    const selected=shuffle([...emojis]).slice(0,8);
    cards=shuffle([...selected,...selected]);
    flippedCards=[];matchedPairs=0;moves=0;score=0;seconds=0;gameActive=true;
    document.getElementById('gameComplete').classList.add('d-none');
    updateDisplay();
    clearInterval(gameTimer);
    gameTimer=setInterval(()=>{seconds++;updateTimer();},1000);
    cards.forEach((emoji,idx)=>{
        const card=document.createElement('div');
        card.className='memory-card';card.dataset.idx=idx;card.dataset.emoji=emoji;card.textContent='‚ùì';
        card.addEventListener('click',()=>flipCard(card));
        board.appendChild(card);
    });
}

function flipCard(card){
    if(!gameActive||flippedCards.length>=2||card.classList.contains('flipped')||card.classList.contains('matched'))return;
    card.classList.add('flipped');card.textContent=card.dataset.emoji;flippedCards.push(card);
    if(flippedCards.length===2){moves++;checkMatch();}
    updateDisplay();
}

function checkMatch(){
    const[a,b]=flippedCards;
    if(a.dataset.emoji===b.dataset.emoji){
        a.classList.add('matched');b.classList.add('matched');matchedPairs++;score+=10;
        flippedCards=[];
        if(matchedPairs===8)endGame();
    }else{
        gameActive=false;
        setTimeout(()=>{a.classList.remove('flipped');b.classList.remove('flipped');a.textContent='‚ùì';b.textContent='‚ùì';flippedCards=[];gameActive=true;},800);
    }
    updateDisplay();
}

function endGame(){
    gameActive=false;clearInterval(gameTimer);
    const bonus=Math.max(0,100-moves*2-seconds);score+=bonus;
    document.getElementById('finalScore').textContent=score+' pts';
    document.getElementById('finalTime').textContent=formatTime(seconds);
    document.getElementById('finalMoves').textContent=moves+' movimentos';
    document.getElementById('gameComplete').classList.remove('d-none');
    fetch('{% url "save_game_score" %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
        body:JSON.stringify({game_name:'Memory Game',score:score,time_spent:seconds})
    });
}

function updateDisplay(){
    document.getElementById('scoreDisplay').textContent='Pontos: '+score;
    document.getElementById('movesDisplay').textContent='Movimentos: '+moves;
}
function updateTimer(){document.getElementById('timerDisplay').textContent='‚è±Ô∏è '+formatTime(seconds);}
function formatTime(s){return Math.floor(s/60)+':'+(s%60<10?'0':'')+s%60;}

document.getElementById('newGameBtn').addEventListener('click',startNewGame);
startNewGame();
</script>
{% endblock %}
