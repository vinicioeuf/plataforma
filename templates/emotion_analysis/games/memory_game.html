{% extends 'base.html' %}

{% block title %}Jogo da MemÃ³ria - Plataforma de SaÃºde Mental{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <h1 class="text-center mb-4">ðŸ§  Jogo da MemÃ³ria</h1>
            
            <div class="row text-center mb-4">
                <div class="col-md-4">
                    <h5>Pares Encontrados: <span id="pairs">0</span>/6</h5>
                </div>
                <div class="col-md-4">
                    <h5>Tentativas: <span id="attempts">0</span></h5>
                </div>
                <div class="col-md-4">
                    <h5>Tempo: <span id="timer">0:00</span></h5>
                </div>
            </div>

            <div id="game-board" class="memory-game mb-4">
                <!-- Cards serÃ£o gerados por JavaScript -->
            </div>

            <div class="text-center">
                <button class="btn btn-primary btn-lg" onclick="resetGame()">Novo Jogo</button>
                <a href="{% url 'games_menu' %}" class="btn btn-secondary btn-lg">Voltar</a>
            </div>

            <div id="game-over" class="alert alert-success mt-4" style="display: none;">
                <h4>ParabÃ©ns! ðŸŽ‰</h4>
                <p>VocÃª completou o jogo em <strong id="final-time"></strong> com <strong id="final-attempts"></strong> tentativas!</p>
                <button class="btn btn-success" onclick="submitScore()">Salvar Score</button>
            </div>
        </div>
    </div>
</div>

<style>
    .memory-game {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        perspective: 1000px;
    }

    .memory-card {
        width: 100%;
        padding-bottom: 100%;
        position: relative;
        cursor: pointer;
    }

    .memory-card-inner {
        position: absolute;
        width: 100%;
        height: 100%;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .memory-card.flipped .memory-card-inner {
        transform: rotateY(180deg);
    }

    .memory-card-front, .memory-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        border-radius: 10px;
    }

    .memory-card-front {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .memory-card-back {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        transform: rotateY(180deg);
    }

    .memory-card.matched .memory-card-back {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
</style>

<script>
    const emojis = ['ðŸŽ¯', 'ðŸŽª', 'ðŸŽ¨', 'ðŸŽ­', 'ðŸŽ¬', 'ðŸŽ¤'];
    let cards = [];
    let flipped = [];
    let matched = [];
    let attempts = 0;
    let startTime = null;
    let timerInterval = null;

    function initGame() {
        const board = document.getElementById('game-board');
        board.innerHTML = '';
        
        // Duplicar emojis e embaralhar
        cards = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
        flipped = [];
        matched = [];
        attempts = 0;
        
        document.getElementById('attempts').textContent = attempts;
        document.getElementById('pairs').textContent = 0;
        document.getElementById('game-over').style.display = 'none';
        
        startTime = Date.now();
        startTimer();
        
        cards.forEach((emoji, index) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'memory-card';
            cardDiv.innerHTML = `
                <div class="memory-card-inner">
                    <div class="memory-card-front">?</div>
                    <div class="memory-card-back">${emoji}</div>
                </div>
            `;
            cardDiv.onclick = () => flipCard(index, cardDiv);
            board.appendChild(cardDiv);
        });
    }

    function flipCard(index, element) {
        if (flipped.includes(index) || matched.includes(index) || flipped.length >= 2) return;
        
        flipped.push(index);
        element.classList.add('flipped');
        
        if (flipped.length === 2) {
            attempts++;
            document.getElementById('attempts').textContent = attempts;
            
            setTimeout(checkMatch, 600);
        }
    }

    function checkMatch() {
        const [first, second] = flipped;
        const match = cards[first] === cards[second];
        
        const cards_elements = document.querySelectorAll('.memory-card');
        
        if (match) {
            matched.push(first, second);
            cards_elements[first].classList.add('matched');
            cards_elements[second].classList.add('matched');
            document.getElementById('pairs').textContent = matched.length / 2;
            
            if (matched.length === cards.length) {
                endGame();
            }
        } else {
            cards_elements[first].classList.remove('flipped');
            cards_elements[second].classList.remove('flipped');
        }
        
        flipped = [];
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    function endGame() {
        clearInterval(timerInterval);
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('final-time').textContent = timeStr;
        document.getElementById('final-attempts').textContent = attempts;
        document.getElementById('game-over').style.display = 'block';
    }

    function resetGame() {
        clearInterval(timerInterval);
        initGame();
    }

    function submitScore() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        fetch('{% url "save_game_score" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                game_name: 'Memory Game',
                score: 100 - attempts * 2,
                time_spent: elapsed
            })
        }).then(r => r.json()).then(d => {
            alert('Score salvo com sucesso!');
        });
    }

    // Inicializar jogo ao carregar
    document.addEventListener('DOMContentLoaded', initGame);
</script>
{% endblock %}
