{% extends 'base.html' %}
{% block title %}Reflex√£o Adaptativa - EmotionAI{% endblock %}
{% block content %}
<div class="container pb-5">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div><h1 class="page-heading"><i class="bi bi-chat-heart"></i> Reflex√£o Adaptativa</h1>
            <p class="text-muted">Perguntas reflexivas adaptadas ao seu humor. ~5 minutos.</p></div>
            <a href="{% url 'games_menu' %}" class="btn btn-outline-light"><i class="bi bi-arrow-left"></i> Voltar</a>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <!-- Mood Selection -->
            <div id="moodSelect" class="card p-4 text-center mb-3">
                <h4 class="fw-bold mb-3">Como voc√™ est√° se sentindo agora?</h4>
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    <button class="btn btn-outline-light p-3 mood-btn" onclick="selectMood('happy')">
                        <div style="font-size:2.5rem;">üòä</div><small>Feliz</small></button>
                    <button class="btn btn-outline-light p-3 mood-btn" onclick="selectMood('sad')">
                        <div style="font-size:2.5rem;">üò¢</div><small>Triste</small></button>
                    <button class="btn btn-outline-light p-3 mood-btn" onclick="selectMood('anxious')">
                        <div style="font-size:2.5rem;">üò∞</div><small>Ansioso</small></button>
                    <button class="btn btn-outline-light p-3 mood-btn" onclick="selectMood('angry')">
                        <div style="font-size:2.5rem;">üò°</div><small>Com Raiva</small></button>
                    <button class="btn btn-outline-light p-3 mood-btn" onclick="selectMood('neutral')">
                        <div style="font-size:2.5rem;">üòê</div><small>Neutro</small></button>
                    <button class="btn btn-outline-light p-3 mood-btn" onclick="selectMood('tired')">
                        <div style="font-size:2.5rem;">üò¥</div><small>Cansado</small></button>
                </div>
            </div>

            <!-- Reflection Area -->
            <div id="reflectionArea" class="d-none">
                <div class="card p-3 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge bg-primary fs-6" id="questionNum">Reflex√£o 1/5</span>
                        <span class="badge bg-info fs-6" id="timerDisplay">‚è±Ô∏è 5:00</span>
                    </div>
                    <div class="progress mt-2" style="height:6px;background:rgba(255,255,255,.1);">
                        <div id="progressBar" class="progress-bar bg-primary" style="width:0%;transition:width .3s ease;"></div>
                    </div>
                </div>
                <div id="questionCard" class="card p-4 text-center mb-3">
                    <div id="qEmoji" style="font-size:3rem;"></div>
                    <h4 id="qText" class="fw-bold mt-2 mb-3"></h4>
                    <textarea id="answerInput" class="form-control" rows="4" placeholder="Escreva sua reflex√£o aqui..." style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:white;resize:none;"></textarea>
                    <div class="d-flex justify-content-between mt-3">
                        <small class="text-muted" id="charCount">0/500</small>
                        <button class="btn btn-primary" onclick="nextQuestion()">Pr√≥xima <i class="bi bi-arrow-right"></i></button>
                    </div>
                </div>
                <div id="affirmation" class="card p-3 text-center d-none" style="background:rgba(76,175,80,.1);border:1px solid rgba(76,175,80,.3);">
                    <p class="mb-0 fw-bold" id="affirmationText"></p>
                </div>
            </div>

            <!-- Complete -->
            <div id="completeCard" class="card p-4 text-center d-none" style="background:linear-gradient(135deg,rgba(103,58,183,.15),rgba(33,150,243,.15));border:2px solid rgba(103,58,183,.4);">
                <h3>üí≠ Reflex√£o Completa!</h3>
                <p class="fs-5">Parab√©ns por dedicar tempo ao autoconhecimento</p>
                <div class="d-flex justify-content-center gap-3 mb-3">
                    <span class="badge bg-primary fs-5 p-2" id="finalScore">0 pts</span>
                    <span class="badge bg-success fs-5 p-2" id="finalAnswered">0 reflex√µes</span>
                </div>
                <div id="summary" class="text-start mb-3"></div>
                <p class="text-muted fst-italic" id="closingMessage"></p>
                <div class="d-flex justify-content-center gap-2 mt-2">
                    <button class="btn btn-success" onclick="restart()"><i class="bi bi-arrow-clockwise"></i> Novo</button>
                    <a href="{% url 'games_menu' %}" class="btn btn-outline-light">Menu</a>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
const QUESTIONS={
    happy:[
        {emoji:'üåü',text:'O que aconteceu hoje que te fez feliz?'},
        {emoji:'üéØ',text:'Como voc√™ pode usar essa energia positiva para ajudar algu√©m?'},
        {emoji:'üôè',text:'Pelo que voc√™ √© mais grato(a) neste momento?'},
        {emoji:'üåà',text:'Qual mem√≥ria feliz voc√™ gostaria de guardar para sempre?'},
        {emoji:'üí´',text:'Que atividade te traz essa mesma sensa√ß√£o de bem-estar?'},
    ],
    sad:[
        {emoji:'üíô',text:'O que est√° pesando no seu cora√ß√£o agora?'},
        {emoji:'ü§ó',text:'Se pudesse falar com um amigo, o que diria?'},
        {emoji:'üå±',text:'Que pequena coisa poderia te trazer um pouco de conforto agora?'},
        {emoji:'üí™',text:'Lembre de um momento dif√≠cil que voc√™ superou. Como conseguiu?'},
        {emoji:'üåÖ',text:'O que voc√™ gostaria que fosse diferente amanh√£?'},
    ],
    anxious:[
        {emoji:'ü´Ç',text:'O que exatamente est√° te preocupando neste momento?'},
        {emoji:'üéØ',text:'Essa preocupa√ß√£o √© algo que voc√™ pode controlar?'},
        {emoji:'üåä',text:'Se pudesse dar um conselho a algu√©m na mesma situa√ß√£o, o que diria?'},
        {emoji:'üìù',text:'Qual o pior cen√°rio poss√≠vel? E qual o mais prov√°vel?'},
        {emoji:'üßò',text:'O que te ajuda a se sentir mais seguro(a)?'},
    ],
    angry:[
        {emoji:'üî•',text:'O que causou essa raiva?'},
        {emoji:'ü§î',text:'Existe outro ponto de vista para essa situa√ß√£o?'},
        {emoji:'üí®',text:'Se essa raiva fosse uma tempestade, como ela seria?'},
        {emoji:'üõ°Ô∏è',text:'Que necessidade sua n√£o est√° sendo atendida?'},
        {emoji:'üïäÔ∏è',text:'O que voc√™ precisa para encontrar paz nessa situa√ß√£o?'},
    ],
    neutral:[
        {emoji:'üîç',text:'O que est√° ocupando seus pensamentos agora?'},
        {emoji:'‚ö°',text:'O que poderia tornar seu dia mais interessante?'},
        {emoji:'üé®',text:'Se pudesse fazer qualquer coisa agora, o que faria?'},
        {emoji:'üìñ',text:'Que li√ß√£o importante voc√™ aprendeu recentemente?'},
        {emoji:'üåü',text:'Qual √© um sonho que voc√™ ainda quer realizar?'},
    ],
    tired:[
        {emoji:'üõå',text:'O que mais est√° consumindo sua energia ultimamente?'},
        {emoji:'‚ö°',text:'O que te recarrega quando est√° esgotado(a)?'},
        {emoji:'üéØ',text:'Existe algo na sua rotina que poderia mudar?'},
        {emoji:'üåø',text:'Quando foi a √∫ltima vez que fez algo s√≥ para voc√™?'},
        {emoji:'üíù',text:'Se pudesse descansar sem culpa, como seria?'},
    ]
};

const AFFIRMATIONS={
    happy:['Sua alegria ilumina o mundo ao redor!','Continue cultivando esses momentos.','A felicidade √© mais bonita quando compartilhada.'],
    sad:['Est√° tudo bem n√£o estar bem.','Essa dor vai passar, voc√™ √© mais forte do que pensa.','Permita-se sentir, sem julgamento.'],
    anxious:['Respire. Voc√™ est√° seguro(a) agora.','Uma coisa de cada vez, n√£o precisa resolver tudo hoje.','Voc√™ j√° enfrentou desafios antes e vai superar.'],
    angry:['Sua raiva √© v√°lida, mas voc√™ decide o que fazer com ela.','Respire fundo. A calma √© uma for√ßa.','Reconhecer a raiva √© o primeiro passo.'],
    neutral:['Momentos neutros s√£o perfeitos para reflex√£o.','A calma √© um superpoder.','Aproveite essa tranquilidade.'],
    tired:['Descansar √© produtivo.','Voc√™ n√£o precisa dar conta de tudo.','Cuide de si como cuidaria de algu√©m querido.'],
};

let mood='',questions=[],currentQ=0,answers=[],score=0,timer=null,seconds=300;

function selectMood(m){
    mood=m;
    questions=[...QUESTIONS[m]];
    currentQ=0;answers=[];score=0;seconds=300;
    document.getElementById('moodSelect').classList.add('d-none');
    document.getElementById('reflectionArea').classList.remove('d-none');
    document.getElementById('completeCard').classList.add('d-none');
    clearInterval(timer);
    timer=setInterval(()=>{
        seconds--;
        document.getElementById('timerDisplay').textContent='‚è±Ô∏è '+formatTime(seconds);
        if(seconds<=0)complete();
    },1000);
    showQuestion();
}

function showQuestion(){
    if(currentQ>=questions.length)return complete();
    const q=questions[currentQ];
    document.getElementById('qEmoji').textContent=q.emoji;
    document.getElementById('qText').textContent=q.text;
    document.getElementById('answerInput').value='';
    document.getElementById('questionNum').textContent=`Reflex√£o ${currentQ+1}/${questions.length}`;
    document.getElementById('progressBar').style.width=(currentQ/questions.length*100)+'%';
    document.getElementById('charCount').textContent='0/500';
    document.getElementById('answerInput').focus();
    
    // Show affirmation
    const affs=AFFIRMATIONS[mood];
    const aff=affs[Math.floor(Math.random()*affs.length)];
    const affDiv=document.getElementById('affirmation');
    document.getElementById('affirmationText').textContent='üí° '+aff;
    affDiv.classList.remove('d-none');
    setTimeout(()=>affDiv.classList.add('d-none'),4000);
}

function nextQuestion(){
    const text=document.getElementById('answerInput').value.trim();
    if(text.length>10){
        answers.push({question:questions[currentQ].text,answer:text});
        score+=20;
    }
    currentQ++;showQuestion();
}

function complete(){
    clearInterval(timer);
    document.getElementById('reflectionArea').classList.add('d-none');
    if(answers.length>=3)score+=30;
    document.getElementById('finalScore').textContent=score+' pts';
    document.getElementById('finalAnswered').textContent=answers.length+' reflex√µes';
    
    const closings={
        happy:'Continue espalhando essa energia positiva! ‚ú®',
        sad:'Voc√™ tomou um passo importante ao refletir. A dor √© tempor√°ria. üíô',
        anxious:'Respirar e refletir j√° ajuda a aliviar a ansiedade. Voc√™ est√° no caminho. üåø',
        angry:'Reconhecer e processar a raiva √© sinal de intelig√™ncia emocional. üïäÔ∏è',
        neutral:'Reflex√£o na calma √© um presente precioso. üåü',
        tired:'Descansar e refletir √© se cuidar. Voc√™ merece. üíù',
    };
    document.getElementById('closingMessage').textContent=closings[mood]||'Parab√©ns pela reflex√£o!';
    document.getElementById('completeCard').classList.remove('d-none');
    
    // Save as journal
    if(answers.length>0){
        const content='üí≠ Reflex√£o adaptativa ('+mood+'):\n\n'+answers.map(a=>`‚ùì ${a.question}\nüí¨ ${a.answer}`).join('\n\n');
        fetch('{% url "save_journal_entry" %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
            body:JSON.stringify({content:content,mood_rating:mood==='happy'?5:mood==='sad'?2:mood==='angry'?2:3,visibility:'private',entry_type:'text'})
        });
    }
    fetch('{% url "save_game_score" %}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':'{{ csrf_token }}'},
        body:JSON.stringify({game_name:'Reflection Game',score:score,time_spent:300-seconds,emotion_before:mood})
    });
}

function restart(){
    document.getElementById('moodSelect').classList.remove('d-none');
    document.getElementById('reflectionArea').classList.add('d-none');
    document.getElementById('completeCard').classList.add('d-none');
}

function formatTime(s){const m=Math.floor(s/60);return m+':'+(s%60<10?'0':'')+(s%60);}
document.getElementById('answerInput').addEventListener('input',function(){
    document.getElementById('charCount').textContent=this.value.length+'/500';
});
</script>
<style>
.mood-btn{min-width:100px;border-radius:16px;transition:all .3s ease;}
.mood-btn:hover{transform:scale(1.05);box-shadow:0 8px 25px rgba(0,0,0,.3);}
</style>
{% endblock %}
