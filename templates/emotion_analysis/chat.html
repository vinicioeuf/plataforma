{% extends 'base.html' %}
{% block title %}Chat com {{ other_user.get_full_name|default:other_user.username }} - EmotionAI{% endblock %}
{% block content %}
<div class="container pb-5">
    <div class="row mb-3">
        <div class="col-12">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <a href="{% url 'friends_list' %}" class="btn btn-sm btn-outline-light"><i class="bi bi-arrow-left"></i></a>
                        <div class="avatar-circle">{{ other_user.username|first|upper }}</div>
                        <div>
                            <strong>{{ other_user.get_full_name|default:other_user.username }}</strong>
                            <small class="d-block {% if other_profile.is_online %}text-success{% else %}text-muted{% endif %}">
                                {% if other_profile.is_online %}ðŸŸ¢ Online{% else %}âšª Offline{% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card" style="height:60vh;display:flex;flex-direction:column;">
                <div id="chatMessages" class="flex-grow-1 p-3" style="overflow-y:auto;display:flex;flex-direction:column;gap:8px;">
                    {% for msg in chat_messages %}
                    <div class="chat-msg {% if msg.sender == request.user %}mine{% else %}theirs{% endif %}">
                        <div class="chat-bubble">{{ msg.content }}</div>
                        <small class="chat-time">{{ msg.created_at|date:"H:i" }}</small>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted my-auto">
                        <div style="font-size:3rem;">ðŸ’¬</div>
                        <p class="mt-2">Nenhuma mensagem ainda. Diga olÃ¡!</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="p-3" style="border-top:1px solid rgba(255,255,255,.1);">
                    <div class="d-flex gap-2">
                        <input type="text" id="msgInput" class="form-control" placeholder="Digite sua mensagem..." autocomplete="off" style="background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);color:white;">
                        <button id="sendBtn" class="btn btn-primary"><i class="bi bi-send"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
.avatar-circle{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;font-weight:bold;color:white;font-size:1.1rem;flex-shrink:0;}
.chat-msg{display:flex;flex-direction:column;max-width:75%;}
.chat-msg.mine{align-self:flex-end;align-items:flex-end;}
.chat-msg.theirs{align-self:flex-start;align-items:flex-start;}
.chat-bubble{padding:10px 16px;border-radius:18px;word-break:break-word;line-height:1.4;}
.chat-msg.mine .chat-bubble{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;border-bottom-right-radius:4px;}
.chat-msg.theirs .chat-bubble{background:rgba(255,255,255,.1);color:white;border-bottom-left-radius:4px;}
.chat-time{font-size:.7rem;color:rgba(255,255,255,.4);margin-top:2px;padding:0 8px;}
</style>
<script>
const userId={{ other_user.id }};
const myId={{ request.user.id }};
const csrfToken='{{ csrf_token }}';
const container=document.getElementById('chatMessages');
const input=document.getElementById('msgInput');
let lastMsgId=0;

function scrollToBottom(){container.scrollTop=container.scrollHeight;}
scrollToBottom();

function sendMessage(){
    const content=input.value.trim();
    if(!content)return;
    input.value='';
    
    // Optimistic UI
    const div=document.createElement('div');div.className='chat-msg mine';
    div.innerHTML=`<div class="chat-bubble">${content}</div><small class="chat-time">${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}</small>`;
    container.appendChild(div);scrollToBottom();
    
    fetch(`/chat/${userId}/send/`,{
        method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
        body:JSON.stringify({content:content})
    });
}

function pollMessages(){
    fetch(`/chat/${userId}/messages/`).then(r=>r.json()).then(data=>{
        if(!data.messages)return;
        // Clear placeholder if exists
        const placeholder=container.querySelector('.text-center.text-muted');
        if(placeholder&&data.messages.length>0)placeholder.remove();
        
        // Replace all content to stay in sync
        const existing=container.querySelectorAll('.chat-msg');
        if(data.messages.length!==existing.length){
            container.innerHTML='';
            data.messages.forEach(m=>{
                const div=document.createElement('div');
                div.className='chat-msg '+(m.is_mine?'mine':'theirs');
                div.innerHTML=`<div class="chat-bubble">${m.content}</div><small class="chat-time">${m.time}</small>`;
                container.appendChild(div);
            });
            scrollToBottom();
        }
    });
}

document.getElementById('sendBtn').addEventListener('click',sendMessage);
input.addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});

setInterval(pollMessages,3000);
</script>
{% endblock %}
